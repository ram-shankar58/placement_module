<div *ngIf="careerTrainingsSandbox.careerTrainingListLoading$ | async as isLoading">
    <div class="overall_div" *ngIf="isLoading">
        <app-skeletonloader *ngFor="let n of skeletonCount"></app-skeletonloader>
    </div>
</div>

<!-- no-placement-events.component.html -->
<div class="event-card empty-state" *ngIf="trainings.length === 0 && !(careerTrainingsSandbox.careerTrainingListLoading$ | async)">
  <div class="icon-wrapper">
    <img src="assets/icons/archive.svg" alt="No Events" class="box-icon" />
  </div>
  <h2 class="title">No Training Created</h2>
  <p class="description">You haven‚Äôt added any training yet. Start by creating one to notify students.</p>
  <div class="actions">
    <button class="btn-primary" (click)="toggleSidebar()">
      <svg class="btn-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
      </svg>
      Add a New Training
    </button>
    <span class="or-text">or</span>
    <a class="upload-link">
      <img src="assets/icons/Upload.svg" alt="Upload Icon" class="btn-icon" />
      Upload bulk Training details
    </a>
  </div>
</div>


<div class="overall_div" style="margin-top: 9px; padding-top:0;" *ngIf="trainings.length !== 0 && !(careerTrainingsSandbox.careerTrainingListLoading$ | async)">
  <div class="add_n_sort_event" style="margin-left: 27px; margin-right: 20px; padding-bottom: 0; display: flex; align-items: center; gap: 24px; flex-wrap: wrap;">
    <div>
      <button class="add-btn" (click)="toggleSidebar()" style="background: linear-gradient(90deg, #7B61FF 0%, #5A43F1 100%); color: #fff; border-radius: 8px; padding: 8px 18px; font-weight: 600; font-size: 15px; border: none; display: flex; align-items: center; gap: 7px; box-shadow: 0 2px 8px rgba(123,97,255,0.08);">
        <img src="assets/icons/add-icon.png"> Add a New Training
      </button>
    </div>
    <div class="addUpload">
      <span class="or-text" style="margin-top: 5px; margin-left:0px">Or</span>
      <a class="upload-link">
        <img src="assets/icons/Upload.svg" alt="Upload Icon" class="btn-icon" />
        Upload bulk training details
      </a>
    </div>
    <div style="flex:1;">
      <div class="search-filter-sort-group" style="display: flex; align-items: center; gap: 16px; justify-content: flex-end;">
        <div class="search-input-wrapper">
          <img src="assets/icons/search-icon.png" alt="Search" class="search-input-icon" />
          <input type="text" class="search-box event-search-input" [(ngModel)]="searchTerm" placeholder="Search" />
        </div>
        <button class="icon-button" (click)="toggleFilterPopup()">
          <img src="assets/icons/filter-icon.png"> Filter
        </button>
        <div class="sort-dropdown-wrapper" style="position: relative; display: inline-block;">
          <button class="icon-button" (click)="toggleSortDropdown()">
            <img src="assets/icons/sort-icon.png"> Sort
          </button>
          <div class="sort-dropdown" *ngIf="isSortDropdownVisible" style="position: absolute; z-index: 10; background: #fff; border: 1px solid #eee; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); min-width: 160px;">
            <div class="sort-option" [class.selected]="sortBy === 'recent'" (click)="setSort('recent')">Recently added</div>
            <div class="sort-option" [class.selected]="sortBy === 'name'" (click)="setSort('name')">Training Name</div>
            <div class="sort-option" [class.selected]="sortBy === 'date'" (click)="setSort('date')">Training Date</div>
            <div class="sort-option" [class.selected]="sortBy === 'type'" (click)="setSort('type')">Training Type</div>
          </div>
        </div>
      </div>
    </div>
  </div>


  <div class="training-card-grid" style="margin-top:9px; padding-top:0; padding-right: 18px">
  <div class="training-card" *ngFor="let training of filteredTrainings | globalFilter : searchTerm">
    <div class="card-menu" (click)="toggleSettings(training, $event)">
      <i class="fas fa-ellipsis-v menu-icon"></i>
      <div class="settings-dropdown" *ngIf="training.showMenu" (click)="$event.stopPropagation()">
        <div class="settings-option blue" (click)="onUpdateTraining(training)">Update training details</div>
        <div class="settings-option blue" (click)="onCopyTraining(training)">Copy as new training</div>
        <div class="settings-option red" (click)="onDeleteTraining(training)">Delete training</div>
      </div>
    </div>
    
    <div class="date-block">
      <div class="date-circle">
        {{ training.date | date:'dd' }}
        <div class="month">{{ training.date | date:'MMM' }}</div>
      </div>
      <div class="time">{{ training.startTime }}</div>
    </div>
    <div></div>
    <div class="training-main">
      <div class="training-type">{{ training.type }}</div>
      <div class="training-title" (click)="openTrainingDetails(training)" style="cursor:pointer;">
        {{ training.title }}
      </div>
      <div class="training-desc">{{ training.description }}</div>
      <div class="meta-row">
        <span [ngClass]="{'on-campus': training.mode === 'On-campus', 'virtual': training.mode === 'Virtual'}" class="mode-badge">
          {{ training.mode }}
        </span>
        <span class="venue"><i class="fa fa-map-marker-alt"></i> {{ training.venue }}</span>
      </div>
    </div>
    <div class="training-info-cols">
      <div class="info-col">
        <span class="label">Scheduled Time</span>
        <span class="value">
          {{ training.startTime | timeAmPm }} to {{ training.endTime | timeAmPm }}
          <span *ngIf="training.recurring" class="recurring">üîÅ</span>
        </span>
      </div>
      <div class="info-col">
        <span class="label">Applicable Batches</span>
        <span class="value">{{ training.batches }}</span>
      </div>
    </div>
    <div class="trainer-col">
      <span class="label">Trainer Name</span>
      <span class="value">{{ training.trainer }}</span>
    </div>
</div>
    
  </div>
</div>

<!-- Sidebar for Add/Edit Training -->
<div class="overlay" *ngIf="issidebarvisible" (click)="toggleSidebar()"></div>
<div class="sidebar" [class.active]="issidebarvisible">
  <form [formGroup]="addTrainingForm" (ngSubmit)="onSubmit()">
    <div class="sidebar-header">
      <button class="close-btn" type="button" (click)="toggleSidebar()">&#10005;</button>
      <h6 style="font-size: 17px; padding-bottom:10px">
        {{ isEditMode ? 'Update Training' : 'Add a New Training' }}
      </h6>
      <p style="font-size: 12px;">
        {{ isEditMode ? 'Update the details of the training below.' : 'Detail out the placement training with the required fields' }}
      </p>
    </div>
    <div class="sidebar-content">

      <!-- 1. Training Basics -->
      <div class="container">
        <div class="step-header">
          <div class="step-icon">1</div>
          <h6>Training Basics</h6>
        </div>
        <div>
          <label>Training title*</label>
          <input type="text" placeholder="Enter a title" formControlName="trainingTitle" />
        </div>
        <div>
          <label>Write about the training</label>
          <textarea placeholder="Enter a description..." formControlName="trainingAbout"></textarea>
        </div>
        <div class="dual-field">
          <div style="height: 65px;">
            <label>Training type</label>
            <div class="custom-select-wrapper">
              <select formControlName="trainingType">
                <option value="" disabled selected>Select</option>
                <option *ngFor="let type of trainingTypes" [value]="type">{{ type }}</option>
              </select>
              <img src="assets/icons/chevron-icon.png" class="dropdown-arrow" />
            </div>
          </div>
          <div>
            <label>Mode of training</label>
            <div class="mode-options">
              <label 
                class="mode-box yellow" 
                [class.selected]="addTrainingForm.get('modeOfTraining')?.value === 'On-campus'"
                (click)="addTrainingForm.get('modeOfTraining')?.setValue('On-campus')"
              >
                <span>
                  <input
                    type="radio"
                    name="modeOfTraining"
                    value="On-campus"
                    class="radioinput"
                    [checked]="addTrainingForm.get('modeOfTraining')?.value === 'On-campus'"
                    (change)="addTrainingForm.get('modeOfTraining')?.setValue('On-campus')"
                  />
                  <strong>On-campus</strong>
                  <div class="description">At your college</div>
                </span>
              </label>
              <label 
                class="mode-box purple" 
                [class.selected]="addTrainingForm.get('modeOfTraining')?.value === 'Virtual'"
                (click)="addTrainingForm.get('modeOfTraining')?.setValue('Virtual')"
              >
                <span>
                  <input
                    type="radio"
                    name="modeOfTraining"
                    value="Virtual"
                    class="radioinput"
                    [checked]="addTrainingForm.get('modeOfTraining')?.value === 'Virtual'"
                    (change)="addTrainingForm.get('modeOfTraining')?.setValue('Virtual')"
                  />
                  <strong>Virtual</strong>
                  <div class="description">Online process</div>
                </span>
              </label>
            </div>
          </div>
        </div>
      </div>

      <!-- 2. Schedule -->
      <div class="container">
        <div class="step-header">
          <div class="step-icon">2</div>
          <h6>Schedule</h6>
        </div>
        <div class="dual-field">
          <div>
            <label>Training date</label>
            <input
              class="form-control"
              placeholder="Select"
              name="trainingDate"
              ngbDatepicker
              formControlName="trainingDate"
              #d="ngbDatepicker"
              (click)="d.toggle()"
              style="background: url('assets/icons/calendar.png') no-repeat right 10px center/20px 20px; padding-right: 36px; cursor:pointer;"
            />
          </div>
          <div>
            <label>Start time</label>
            <div class="input-icon-right">
              <input
                type="text"
                formControlName="startTime"
                readonly
                placeholder="Select"
                (click)="showStartClock = !showStartClock"
                style="background: url('assets/icons/clock.png') no-repeat right 10px center/20px 20px; padding-right: 36px; cursor:pointer;"
              />
              <div *ngIf="showStartClock" class="timepicker-container">
                <lib-ng-timepick (timeSelected)="onStartTimeSelected($event)"></lib-ng-timepick>
              </div>
            </div>
          </div>
          <div>
            <label>End time</label>
            <div class="input-icon-right">
              <input
                type="text"
                formControlName="endTime"
                readonly
                placeholder="Select"
                (click)="showEndClock = !showEndClock"
                style="background: url('assets/icons/clock.png') no-repeat right 10px center/20px 20px; padding-right: 36px; cursor:pointer;"
              />
              <div *ngIf="showEndClock" class="timepicker-container">
                <lib-ng-timepick (timeSelected)="onEndTimeSelected($event)"></lib-ng-timepick>
              </div>
            </div>
          </div>
        </div>
        <div class="dual-field">
          <div>
            <label>Venue or platform</label>
            <input type="text" placeholder="Type a location" formControlName="venue" />
          </div>
          <div>
            <label>Applicable batches</label>
            <div class="batches-multiselect" tabindex="0" (click)="toggleBatchDropdown()" formControlName="applicableBatches">
              <div class="chips-input-row">
                <span *ngFor="let batch of selectedBatches" class="batch-chip">
                  {{ batch }}
                  <i class="fa fa-times" (click)="removeBatch(batch, $event)"></i>
                </span>
                <img src="assets/icons/chevron-icon.png" class="dropdown-arrow" />
              </div>
              <div class="dropdown-list" *ngIf="batchDropdownOpen" (click)="$event.stopPropagation()">
                <div
                  *ngFor="let batch of batchesList"
                  class="dropdown-option"
                  [class.selected]="selectedBatches.includes(batch)"
                  (click)="toggleBatch(batch, $event)"
                >
                  {{ batch }}
                  <span *ngIf="selectedBatches.includes(batch)" class="checkmark">&#10003;</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div>
          <label>Trainer name</label>
          <input type="text" placeholder="Enter name of the trainer" formControlName="trainerName" />
        </div>
      </div>

      <!-- 3. Schedule Timetable -->
      <div class="container">
        <div class="step-header">
          <div class="step-icon">3</div>
          <h6>Schedule Timetable</h6>
        </div>
        <div class="dual-field">
          <div>
            <label>Recursive training</label>
            <label class="switch">
              <input type="checkbox" formControlName="recursiveTraining" />
              <span class="slider"></span>
            </label>
          </div>
        </div>
        <div class="dual-field">
          <div>
            <label>Repeat this training every</label>
            <div class="custom-select-wrapper">
              <select formControlName="repeatTraining">
                <option value="Week">Week</option>
                <option value="Month">Month</option>
              </select>
              <img src="assets/icons/chevron-icon.png" class="dropdown-arrow" />
            </div>
          </div>
          <div>
            <label>Select the day</label>
            <div class="custom-select-wrapper">
              <select formControlName="selectDay">
                <option>Monday</option>
                <option>Tuesday</option>
                <option>Wednesday</option>
                <option>Thursday</option>
                <option>Friday</option>
                <option>Saturday</option>
                <option>Sunday</option>
              </select>
              <img src="assets/icons/chevron-icon.png" class="dropdown-arrow" />
            </div>
          </div>
        </div>
        <div class="dual-field">
          <div>
            <label>Repeat until</label>
            <input
              class="form-control"
              placeholder="Select"
              name="repeatUntill"
              ngbDatepicker
              formControlName="repeatUntill"
              #repeatUntilPicker="ngbDatepicker"
              (click)="repeatUntilPicker.toggle()"
              style="background: url('assets/icons/calendar.png') no-repeat right 10px center/20px 20px; padding-right: 36px; cursor:pointer;"
            />
          </div>
          <div></div>
        </div>
      </div>
    </div>
    <div class="sidebar-footer">
      <button class="cancel_btn" type="button" (click)="toggleSidebar()">Cancel</button>
      <button class="submit_btn" type="submit" [disabled]="addTrainingForm.invalid">
        {{ isEditMode ? 'Update Event Details' : 'Save Event Details' }}
      </button>
    </div>
  </form>
</div>
<!-- Training Details Modal -->
<div *ngIf="isTrainingDetailPopupVisible" class="modal-overlay">
  <div class="modal">
    <div class="modal-header d-flex px-4 py-3">
      <h3>Training Details</h3>
      <button class="close-btn" (click)="closeTrainingDetails()"><img src="assets/icons/x.png" style="width: 22px; height:22px; padding: 0; margin:0; float: right;" /></button>
    </div>

    <div class="modal-section event-title px-4 pt-3 pb-2">
      <div style="font-size: 18px; font-weight: 700; color: #22223b;">
        {{ selectedTraining?.title }}
      </div>
      <div class="meta mt-1">
        <span>
          {{ selectedTraining?.date | date:'dd MMM yyyy' }},
          {{ selectedTraining?.startTime | timeAmPm }} to {{ selectedTraining?.endTime | timeAmPm }}
        </span>
        <span
          class="badge"
          [ngClass]="{
            'on-campus': selectedTraining?.mode === 'On-campus',
            'virtual': selectedTraining?.mode === 'Virtual'
          }"
        >
          {{ selectedTraining?.mode }}
        </span>
        <span class="venue" *ngIf="selectedTraining?.venue">
          <i class="fa fa-map-marker-alt"></i> {{ selectedTraining?.venue }}
        </span>
      </div>
      <div *ngIf="selectedTraining?.recurring" style="color: #ff9800; margin-top: 6px;">
        <i class="fa fa-sync-alt"></i>
        Recursive training (Every {{selectedTraining?.repeat}} {{selectedTraining?.day}} until
        {{selectedTraining?.repeatUntil | date:'dd MMM yyyy'}})
      </div>
    </div>

    <div class="modal-section">
      <label>Event Description</label>
      <div class="popup-value">{{ selectedTraining?.description }}</div>
    </div>
    <div class="modal-section">
      <label>Applicable batches</label>
      <div class="badges">
        {{ selectedTraining?.batches }}
      </div>
    </div>
    <div class="modal-section">
      <label>Trainer Name</label>
      <div class="popup-value">{{ selectedTraining?.trainer }}</div>
    </div>

    <div class="modal-footer mt-3">
      <button class="update-btn" (click)="editTraining(selectedTraining)">Update Training Details</button>
      <button class="close-btn-plain" (click)="closeTrainingDetails()">Close</button>
    </div>
  </div>
</div>

<!-- Filter Popup -->
<div class="filter-popup-overlay" *ngIf="isFilterVisible" (click)="closeFilterPopup()"></div>
<div class="filter-popup" *ngIf="isFilterVisible">
  <div class="filter-header">
    <span>Filter Trainings</span>
    <button class="close-btn" (click)="closeFilterPopup()">
      <img src="assets/icons/x.png" style="width: 22px; height: 22px;" alt="Close" />
    </button>
  </div>
  <div class="filter-section">
    <label style="padding-top:10px;">Training type</label>
    <div class="filter-type-options">
      <label>
        <input type="checkbox" value="On-campus" (change)="onFilterModeChange($event)" [checked]="filterModes.includes('On-campus')" /> On-campus
      </label>
      <label>
        <input type="checkbox" value="Virtual" (change)="onFilterModeChange($event)" [checked]="filterModes.includes('Virtual')" /> Virtual
      </label>
    </div>
  </div>
  <div class="filter-section dual-field">
    <div>
      <label>From</label>
      <input
        ngbDatepicker
        placeholder="Select"
        [(ngModel)]="filterFromDate"
        #fromDatePicker="ngbDatepicker"
        (click)="fromDatePicker.toggle()"
        class="form-control"
        style="background: url('assets/icons/calendar.png') no-repeat right 10px center/20px 20px; padding-right: 36px;"
      />
    </div>
    <div>
      <label>To</label>
      <input
        ngbDatepicker
        placeholder="Select"
        [(ngModel)]="filterToDate"
        #toDatePicker="ngbDatepicker"
        (click)="toDatePicker.toggle()"
        class="form-control"
        style="background: url('assets/icons/calendar.png') no-repeat right 10px center/20px 20px; padding-right: 36px;"
      />
    </div>
  </div>
  <div class="filter-section">
    <label class="switch-label">
      <label class="switch">
        <input type="checkbox" [(ngModel)]="filterRecursive" />
        <span class="slider"></span>
      </label>
      Show recursive trainings
    </label>
  </div>
  <div class="filter-footer">
    <a class="clear-btn" (click)="resetFilters()">Clear filter</a>
    <button class="apply-btn" (click)="applyFilters()">Apply</button>
  </div>
</div>