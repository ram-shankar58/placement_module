<div class="overall_div">
  <div class="add_n_sort_event row align-items-center mb-3">
    <div class="col-auto">
      <button class="add-btn" (click)="toggleSidebar()">
        <i class="fa fa-plus-circle"></i> Add a New Event
      </button>
    </div>
    <div class="col">
      <input type="text" class="search-box event-search-input" [(ngModel)]="eventSearch" placeholder="Search" />
    </div>
    <div class="col-auto">
      <div class="icon-button">
        <i class="fa fa-filter"></i> Filter
      </div>
    </div>
    <div class="col-auto">
      <div class="sort-dropdown-wrapper" style="position: relative; display: inline-block;">
  <button class="icon-button" (click)="sortDropdownOpen = !sortDropdownOpen">
    <i class="fa fa-sort"></i> Sort
  </button>
  <div class="sort-dropdown" *ngIf="sortDropdownOpen" style="position: absolute; z-index: 10; background: #fff; border: 1px solid #eee; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); min-width: 160px;">
    <div class="sort-option" [class.selected]="sortOption === 'recent'" (click)="setSort('recent')">Recently added</div>
    <div class="sort-option" [class.selected]="sortOption === 'name'" (click)="setSort('name')">Event Name</div>
    <div class="sort-option" [class.selected]="sortOption === 'date'" (click)="setSort('date')">Event Date</div>
    <div class="sort-option" [class.selected]="sortOption === 'type'" (click)="setSort('type')">Event Type</div>
  </div>
</div>
    </div>
  </div>

  <div class="sidebar" [class.active]="issidebarvisible">
    <form [formGroup]="addEventForm">
      <div class="sidebar-scrollable">
        <div class="sidebar-header">
          <button class="close-btn" type="button" (click)="cancel()">&#10005;</button>
          <h6 style="font-size: 17px;">Add a New Event</h6>
          <p style="font-size: 12px;">Detail out the placement event with the required fields</p>
        </div>

        <!-- Sidebar Content -->
        <div class="sidebar-content">
          <div class="container">
            <div class="step-header">
              <div class="step-icon">1</div>
              <h6>Event Basics</h6>
            </div>

            <div class="sidebar-sub-section">
              <label>Event title<span style="color: red;">*</span></label>
              <input type="text" placeholder="Enter a title" formControlName="eventTitle">
              <div class="error" *ngIf="submitted && addEventForm.get('eventTitle')?.invalid">
                Event title is required.
              </div>
            </div>

            <div class="sidebar-sub-section">
              <label>Write about the event</label>
              <textarea placeholder="Enter a description..." formControlName="aboutEvent"></textarea>
            </div>

            <div class="mode-options">
              <label 
                class="mode-box yellow" 
                [class.selected]="addEventForm.get('modeOfEvent')?.value === 'On-campus'"
                (click)="addEventForm.get('modeOfEvent')?.setValue('On-campus')"
              >
                <span>
                  <input type="radio" name="modeOfEvent" value="On-campus" class="radioinput" /><strong>On-campus</strong>
                  <!-- <div class="description">At your college</div> -->
                </span>
              </label>
              <label 
                class="mode-box green" 
                [class.selected]="addEventForm.get('modeOfEvent')?.value === 'Off-campus'"
                (click)="addEventForm.get('modeOfEvent')?.setValue('Off-campus')"
              >
                <span>
                  <input type="radio" name="modeOfEvent" value="Off-campus" class="radioinput" /><strong>Off-campus</strong>
                </span>
                <!-- <div class="description">External drive</div> -->
              </label>
              <label 
                class="mode-box blue" 
                [class.selected]="addEventForm.get('modeOfEvent')?.value === 'Pool'"
                (click)="addEventForm.get('modeOfEvent')?.setValue('Pool')"
              >
                <span>
                  <input type="radio" name="modeOfEvent" value="Pool" class="radioinput" /><strong>Pool</strong>
                </span>
                <!-- <div class="description">Multi-college drive</div> -->
              </label>
              <label 
                class="mode-box purple" 
                [class.selected]="addEventForm.get('modeOfEvent')?.value === 'Virtual'"
                (click)="addEventForm.get('modeOfEvent')?.setValue('Virtual')"
              >
                <span>
                  <input type="radio" name="modeOfEvent" value="Virtual" class="radioinput" /><strong>Virtual</strong>
                </span>
                <!-- <div class="description">Online process</div> -->
              </label>
            </div>
          </div>

          <!-- Schedule -->
          <div class="container">
            <div class="step-header">
              <div class="step-icon">2</div>
              <h6>Schedule</h6>
            </div>
            <div class="dual-field">
  <div class="sidebar-sub-section" style="flex: 1;">
    <label>Event date as scheduled<span style="color: red;"> *</span></label>
    <input
      class="form-control"
      placeholder=""
      name="dp"
      ngbDatepicker
      formControlName="eventDate"
      [ngClass]="{ 'is-invalid': submitted && addEventForm.controls['eventDate'].errors }"
      #d="ngbDatepicker"
      (click)="d.toggle()"
      style="background: url('assets/icons/calendar.png') no-repeat right 10px center/20px 20px; padding-right: 36px;"
    />
    <div *ngIf="submitted && addEventForm.controls['eventDate'].errors" class="invalid-feedback d-block">
      Event date is required.
    </div>
  </div>

  <div class="sidebar-sub-section" style="flex: 1;">
    <label>Event start time</label>
    <div class="input-icon-right">
      <input
        type="text"
        placeholder=""
        formControlName="eventTime"
        readonly
        (click)="showClock = !showClock"
        style="background: url('assets/icons/clock.png') no-repeat right 10px center/20px 20px; padding-right: 36px;"
      />
      <div *ngIf="showClock" class="timepicker-container">
        <app-custom-timepicker (timeSelected)="onTimeSelected($event)"></app-custom-timepicker>
      </div>
      <div class="error" *ngIf="submitted && addEventForm.get('eventTime')?.hasError('invalidTime')">
        Please enter a valid time in HH:MM (e.g., 23:45).
      </div>
    </div>
  </div>
</div>

            <br>
            <div class="sidebar-sub-section">
              <label>Venue or platform</label>
              <input type="text" placeholder="Type a location" formControlName="venue"/>
            </div>
          </div>

          <!-- Associated Companies -->
          <div class="container">
            <div class="step-header">
              <div class="step-icon">3</div>
              <h6>Associated Companies</h6>
            </div>
            <div class="sidebar-sub-section">
  <label>Company detail</label>
  <input
    type="text"
    placeholder="Search or type to add"
    [(ngModel)]="companySearch"
    (input)="onCompanySearch()"
    (keydown.enter)="addCompanyFromInput()"
    [ngModelOptions]="{standalone: true}"
    class="company-search-input"
    autocomplete="off"
  />
  <div class="company-search-dropdown" *ngIf="filteredCompanies?.length && showCompanyDropdown">
    <div
      class="company-search-option"
      *ngFor="let company of filteredCompanies"
      (click)="selectCompany(company)"
    >
      <img [src]="company.logo" alt="{{company.companyName}}" class="company-logo-mini" />
      {{ company.companyName }}
    </div>
  </div>
  <small *ngIf="!filteredCompanies?.length && companySearch && showCompanyDropdown">
    No companies found. Press Enter to add "{{ companySearch }}"
  </small>
  <div class="selected-companies">
    <div class="selected-company-chip" *ngFor="let comp of selectedCompanies">
      <img [src]="comp.logo" alt="{{comp.companyName}}" class="company-logo-mini" />
      {{ comp.companyName }}
      <span class="remove-chip" (click)="removeCompany(comp)">×</span>
    </div>
  </div>
</div>
          </div>

          <!--  Eligibility -->
          <div class="container">
            <div class="step-header">
              <div class="step-icon">4</div>
              <h6>Eligibility</h6>
            </div>
            <div class="dual-field">
              <div class="sidebar-sub-section">
  <label>Eligible Courses</label>
  <div class="dropdown-wrapper" (clickOutside)="closeDropdown()">
  <button type="button" class="custom-dropdown-btn" (click)="toggleDropdown()">
    {{ selectedCourses.length ? selectedCourses.join(', ') : 'Select eligible courses' }}
    <i class="fa fa-caret-down"></i>
  </button>

  <div class="custom-dropdown-list" *ngIf="dropdownOpen">
    <label *ngFor="let course of coursesList" class="dropdown-option">
      <input
        type="checkbox"
        [value]="course"
        (change)="onCourseCheckboxChange(course, $event)"
        [checked]="selectedCourses.includes(course)"
      />
      {{ course }}
    </label>
  </div>
</div>


</div>



              
              <div>
                <label>Eligibility criteria</label>
                <input type="text" placeholder="Enter criteria" formControlName="eligibleCriteria" />
              </div>
            </div>
          </div>

          <!-- Selection process -->
          <div class="container">
            <div class="step-header">
              <div class="step-icon">5</div>
              <h6>Selection process</h6>
            </div>
            <div style="display: flex;">
              <input type="checkbox" style="margin-left: 15px;" [checked]="addEventForm.get('selectionProcess')?.value?.includes('Aptitude test')" (change)="onRoundCheckboxChange($event, 'Aptitude test')" /> Aptitude test
              <input type="checkbox" style="margin-left: 15px;" [checked]="addEventForm.get('selectionProcess')?.value?.includes('Technical interview')" (change)="onRoundCheckboxChange($event, 'Technical interview')" /> Technical interview
              <input type="checkbox" style="margin-left: 15px;" [checked]="addEventForm.get('selectionProcess')?.value?.includes('HR interview')" (change)="onRoundCheckboxChange($event, 'HR interview')" /> HR interview
            </div>
          </div>
        </div>

        <div class="sidebar-footer">
          <button class="cancel_btn" type="button" (click)="cancel()">Cancel</button>
          <button class="submit_btn"
            type="submit"
            [disabled]="addEventForm.invalid"
            [ngClass]="{ 'active': addEventForm.valid }"
            (click)="addEvent()">Save Event Details
          </button>
        </div>
      </div>
    </form>
  </div>

  <!-- upcoming events table -->
  <div class="events-grid" style="display: flex; flex-wrap: wrap; gap: 24px;">
    <div class="events-card" style="flex: 1 1 45%; max-width: 48%;" *ngFor="let event of sortedEvents | globalFilter:eventSearch">
      <div class="event-card">
        <div class="header" (click)="openEventDetails(event)" style="cursor: pointer;">
          <div>
            <div class="step-header-events">
              <div class="step-icon-events">
                <div class="date" style="align-items: center; text-align: center;">{{ event.eventDate | date: 'dd' }}
                  <div class="month" style="align-items: center; text-align: center;">{{ event.eventDate | date: 'MMM' }}</div>
                </div>
              </div>
            </div>
          </div>
          <div class="event-details">
            <div class="event-id">{{ event.id }}</div>
            <div class="title">{{ event.eventTitle }}</div>
            <div class="meta">
              <span class="time" *ngIf="event.eventTime?.length">{{ event.eventTime | timeAmPm }}</span>
              <span
  class="badge eventviewbadge"
  [ngClass]="{
    'on-campus': event.modeOfEvent === 'On-campus',
    'off-campus': event.modeOfEvent === 'Off-campus',
    'pool': event.modeOfEvent === 'Pool',
    'virtual': event.modeOfEvent === 'Virtual'
  }"
  *ngIf="event.modeOfEvent?.length"
>
  {{ event.modeOfEvent }}
</span>
              <img src="assets/icons/location_on.png"  *ngIf="event.venue?.length"> <span class="venue" *ngIf="event.venue?.length">{{ event.venue }}</span>
            </div>
          </div>
        </div>

        <div class="companies" *ngIf="event.companyDetails?.length" >
          <ng-container  *ngFor="let company of event.companyDetails; let i = index">
            <ng-container *ngIf=" i < 4">
              <img [src]="company.logo" alt="{{company.companyName}} logo" class="company-logo" />
              <span style="color:#007AFF"> {{company.companyName}} </span>
            </ng-container>
            <span *ngIf="i === 4" class="more-companies">+ {{ event.companyDetails.length - i }} more </span>
          </ng-container>
        </div>
        
        <div class="course-eligibility" *ngIf="getFilteredEligibleCourses(event).length || event.eligibleCriteria">
          <div *ngIf="getFilteredEligibleCourses(event).length">
            <label>Eligible Courses</label>
            <div *ngIf="getFilteredEligibleCourses(event).length">{{ event.eligibleCourses?.join(', ') || '' }}</div>
          </div>
          <div *ngIf="event.eligibleCriteria">
            <label>Eligibility Criteria</label>
            <div *ngIf="event.eligibleCriteria">{{ event.eligibleCriteria }}</div>
          </div>
        </div>

        
        <!-- <div class="footer">
          <div class="status" *ngIf="event.status === 'not_sent'">
            <span class="warning">⚠️ Event not sent to students yet</span>
          </div>
          <button class="shortlist-btn" *ngIf="event.status === 'not_sent'; else showShortlist">Shortlist Students</button>
          <ng-template #showShortlist>
            <span>12 students shortlisted</span>
          </ng-template>
        </div> -->
      </div>
    </div>
  </div>
  <div class="modal-overlay" *ngIf="selectedEvent" (click)="closeEventDetails()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Event Details</h3>
        <button class="close-btn" (click)="closeEventDetails()"><img src="assets/icons/x.png" /> </button>
      </div>

      <div class="modal-section">
        <label>Event Title</label>
        <div class="event-title">
          <strong>{{ selectedEvent.eventTitle }}</strong>
          <div class="meta">
            {{ selectedEvent.eventDate | date: 'dd MMM yyyy' }} {{ selectedEvent.eventTime | timeAmPm}} 
            <span
  class="badge eventviewbadge" *ngIf="selectedEvent.modeOfEvent?.length"
  [ngClass]="{
    'on-campus': selectedEvent.modeOfEvent?.toLowerCase() === 'on-campus',
    'off-campus': selectedEvent.modeOfEvent?.toLowerCase() === 'off-campus',
    'pool': selectedEvent.modeOfEvent?.toLowerCase() === 'pool',
    'virtual': selectedEvent.modeOfEvent?.toLowerCase() === 'virtual'
  }"
>
  {{ selectedEvent.modeOfEvent }}
</span>
            <img src="assets/icons/location_on.png" *ngIf="selectedEvent.venue?.length"> {{ selectedEvent.venue }}
          </div>
        </div>
      </div>

      <div class="modal-section" *ngIf="selectedEvent.aboutEvent">
        <label>Event Description</label>
        <p>{{ selectedEvent.aboutEvent }}</p>
      </div>

      <div class="modal-section" *ngIf="selectedEvent.companyDetails?.length">
        <label>Associated Companies</label>
        <div class="companies">
          <img *ngFor="let comp of selectedEvent.companyDetails" [src]="comp.logo" [alt]="comp.companyName" />
        </div>
      </div>

      <div class="modal-section" *ngIf="getFilteredEligibleCourses(selectedEvent).length">
        <label>Eligible Courses</label>
        <p>{{ getFilteredEligibleCourses(selectedEvent).join(', ') }}</p>
      </div>

      <div class="modal-section" *ngIf="selectedEvent.eligibleCriteria">
        <label>Eligibility Criteria</label>
        <p><strong>{{ selectedEvent.eligibleCriteria }}</strong></p>
      </div>

      <div class="modal-section" *ngIf="getFilteredSelectionProcess(selectedEvent)?.length">
  <label>Selection Process</label>
  <div class="badges">
    <span *ngFor="let round of selectedEvent.selectionProcess" class="badge">
  <ng-container [ngSwitch]="round">
    <img *ngSwitchCase="'Aptitude test'" src="assets/icons/selection-icon.png" alt="Aptitude" />
    <img *ngSwitchCase="'Technical interview'" src="assets/icons/selection-icon.jpg" alt="Technical" />
    <img *ngSwitchCase="'HR interview'" src="assets/icons/selection-icon.jpg" alt="HR" />
  </ng-container>
  {{ round }}
</span>
  </div>
</div>

      <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 10px;">
        <button class="update-btn">Update Event Details</button>
        <button class="close-btn-plain" (click)="closeEventDetails()">Close</button>
      </div>
    </div>
  </div>
</div>